---
title: "Data Science--NECC Proposal"
author: "Nate Hermann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: TRUE
bibliography: Bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "cairo_pdf",cache=T,fig.align="left",fig.pos="!h")


library(ggplot2)
library(tidyverse)
library(magrittr)
library(readr)
library(sf)
library(ggspatial)
library(gridExtra)
library(moments)
library(dendextend)


theme_set(theme_bw(base_size=22))
seasonPal2<-c("deepskyblue4","yellowgreen","goldenrod1","orange3") #BEST


```

``` {r data,include=F}


load("Data/googleMap.zoom6.eastCoast.R")
load("Data/prey19.RData")
load("Data/pylen19.RData")
allTrawls<-read_csv("Data/allTrawls.csv")
statAreas<-st_read("Data/Statistical_Areas_2010_withNames.shp",quiet=T)
statAreas<-filter(statAreas,Id%in%allTrawls$AREA)
statAreas<-st_transform(statAreas,4326)

prey19%<>%
  mutate(geoarea=factor(geoarea,levels=c("MAB","SNE","GB","GoM","ScS")))


#Using shapefiles to build a clean map
world<-map_data("world")
states<-map_data("state")


#The names of my species, just to have them nice and handy for later
myspecies_sci<-unique(str_to_upper(prey19$pdscinam))
myspecies_com<-unique(str_to_title(prey19$pdcomnam))

```


``` {r editing, include=F}

#Modifying the data as needed

#Available diets
prey19<-prey19%>%
  mutate(gensci=ifelse(pynam=="PRIONOTUS ALATUS"|pynam=="STERNOPTYCHIDAE","FISH",as.character(gensci)),
         analsci=ifelse(pynam=="PRIONOTUS ALATUS","TRIGLIDAE",as.character(analsci)),
         collsci=ifelse(pynam=="PRIONOTUS ALATUS",as.character(pynam),as.character(collsci)),
         analsci=ifelse(pynam=="STERNOPTYCHIDAE","STERNOPTYCHIDAE",as.character(analsci)),
         collsci=ifelse(pynam=="STERNOPTYCHIDAE","STERNOPTYCHIDAE",as.character(collsci)),
         year=ifelse(is.na(year),substr(cruise6,1,4),year),year=as.numeric(year))%>%
  filter(pdlen<300) #There is a Summer Flounder that was listed at 300 cm, which is unbelievable, so it will be dropped


uniquePrey19<-prey19%>%
  dplyr::select(cruise6,station,svspp,pdsex,pdid,fhdat,pdcomnam,pdscinam,pdlen,pdwgt,sizecat,pdgutw,pdgutv,declat,declon,month,day,year,season,geoarea)%>%
  distinct()%>%
  mutate(cruise6=as(cruise6,"character"),pdsex=as.character(pdsex),
         station=as.character(str_sub(paste0("0000",station),-4,-1)))

min<-uniquePrey19%>%
  filter(!is.na(year)&season%in%c("SPRING","FALL"))%>%
  mutate(pdcomnam=str_to_title(pdcomnam),
         year=as.factor(year),
         season=factor(str_to_sentence(season),levels=c("Spring","Fall")))%>%
  group_by(pdcomnam,year,season,.drop=F)%>%
  summarise(count=n())%>%distinct()%>%
  group_by(pdcomnam)%>%
  mutate(year=as.character(year),
         season=as.character(season))%>%
  filter(year>=min(subset(year,count>0)))%>%
  summarise(min=min(count,na.rm=T),
            minyear=subset(year,count==min(count,na.rm=T)),
            minseason=subset(season,count==min(count,na.rm=T)))%>%
  summarise(min=min,
            minyearseason=ifelse(n()>1,paste(n(),"times"),paste(minseason,minyear)))%>%distinct()



#The categories from Garrison and Link, 2000
gl_preycats<-read.csv("Data/GarrisonLink_preyCats.csv")%>%
  mutate(matchingCats=gsub("p\\.","",Scientific.name),
         matchingCats=gsub("crabs","crab",matchingCats),
         matchingCats=gsub("Gammaridae","Gammaridea",matchingCats),
         matchingCats=gsub("Cnidarians","Cnidaria",matchingCats))

prey19<-prey19%>%
  mutate(INgen=ifelse(str_to_sentence(gensci) %in% gl_preycats$matchingCats,1,0),
         INanal=ifelse(str_to_sentence(analsci) %in% gl_preycats$matchingCats,1,0),
         INcoll=ifelse(str_to_sentence(collsci) %in% gl_preycats$matchingCats,1,0),
         INpy=ifelse(str_to_sentence(pynam) %in% gl_preycats$matchingCats,1,0))
prey19<-prey19%>%
  mutate(INnum=rowSums(prey19[,c("INgen","INanal","INcoll","INpy")]),
         gl_prey=ifelse(INnum==4,str_to_sentence(pynam), #STEP 1 
                  ifelse(INnum==3&INpy==1,str_to_sentence(pynam),
                   ifelse(INnum==3&INpy==0,str_to_sentence(collsci),
                    ifelse(INnum==2&INpy==1,str_to_sentence(pynam),
                     ifelse(INnum==2&INgen==1,str_to_sentence(analsci),
                      ifelse(INnum==2&INgen==0&INpy==0,str_to_sentence(collsci),
                       ifelse(INnum==1&INgen==1,str_to_sentence(gensci),
                        ifelse(INnum==1&INanal==1,str_to_sentence(analsci),
                         ifelse(INnum==1&INcoll==1,str_to_sentence(collsci),
                          ifelse(INnum==1&INpy==1,str_to_sentence(pynam),
                           ifelse(INnum==0&pynam=="EMPTY","Empty",NA))))))))))),
         gl_prey=ifelse(pynam %in% c("UROPHYCIS CHUSS","UROPHYCIS TENUIS","UROPHYCIS REGIA"),"Other hakes", #STEP 2
                  ifelse(analsci %in% c("GADIDAE","BREGMACEROTIDAE","EUCLICHTHYIDAE","LOTIDAE","MACROURIDAE",
                                        "MELANONIDAE","MERLUCCIIDAE","MORIDAE","MURAENOLEPIDIDAE","PHYCIDAE") & 
                           is.na(gl_prey),"Gadiformes", #STEP 3a
                   ifelse(analsci %in% c("PLEURONECTIDAE","PSETTODIDAE","CITHARIDAE","SCOPHTHALMIDAE","PARALICHTHYIDAE",
                                         "BOTHIDAE","PARALICHTHODIDAE","POECILOPSETTIDAE","RHOMBOSOLEIDAE",
                                         "ACHIROPSETTIDAE","SAMARIDAE","ACHIRIDAE","SOLEIDAE","CYNOGLOSSIDAE") & 
                            is.na(gl_prey), "Pleuronectiformes", #STEP 3b
                    ifelse(gensci=="FISH" & is.na(gl_prey),"Other fish", #STEP 4
                     ifelse((gensci %in% c("UROCHORDATA","BRACHIOPODA","BRYOZOA","CHAETOGNATHA","PORIFERA") | 
                              collsci %in% c("ARTHROPODA","INSECTA","HEMICHORDATA","LIMULUS POLYPHEMUS",
                                             "APHRODITIDAE","OLIGOCHAETA","HIRUDENEA","PYCNOGONIDA")) & 
                           is.na(gl_prey),"Other invertebrates", #STEP 5
                      ifelse(analsci %in% c("CEPHALOCHORDATA"),"Other", #STEP 6
                       ifelse(collsci %in% c("OSTRACODA","CUMACEA","STOMATOPODA","PENAEIDAE"),
                              "Crustacean shrimp", #STEP 7
                        ifelse(analsci %in% c("CIRRIPEDIA","COPEPODA") | 
                                 pynam %in% c("DECAPODA","DECAPODA EGGS","DECAPODA LARVAE"),"Crustacea", #STEP 8
                         ifelse(collsci %in% c("HOMARUS AMERICANUS","CALLINECTES SAPIDUS","DECAPODA LARVAE","SCYLLARIDAE") &
                                  is.na(gl_prey), "Decapoda crab", #STEP 9
                          ifelse(analsci=="EUPHAUSIACEA","Euphausiidae",gl_prey))))))))))) #STEP 10



#How many different levels are there in all the different levels
itemDetails<-prey19%>%
  mutate(total_pynam=n_distinct(pynam),
         total_gennam=n_distinct(gensci),
         total_analnam=n_distinct(analsci),
         total_colnam=n_distinct(collsci),
         total_glnam=n_distinct(gl_prey))%>%
  group_by(gensci)%>%
  mutate(gen_pynam=n_distinct(pynam),
         gen_analnam=n_distinct(analsci),
         gen_colnam=n_distinct(collsci))%>%
  ungroup()%>%
  group_by(analsci)%>%
  mutate(anal_pynam=n_distinct(pynam),
         anal_colnam=n_distinct(collsci))%>%
  ungroup()%>%
  group_by(collsci)%>%
  mutate(coll_pynam=n_distinct(pynam))%>%
  dplyr::select(pynam,gensci,analsci,collsci,total_pynam:coll_pynam)%>%unique()
itemDetails<-itemDetails[,c("gensci","analsci","collsci","pynam","total_gennam","total_glnam","total_analnam","total_colnam",
                            "total_pynam","gen_analnam","gen_colnam","gen_pynam","anal_colnam","anal_pynam","coll_pynam")]  





#How often are each of the predators prey to each of the predators
speciesPrey<-prey19%>%
  group_by(pdscinam)%>%
  mutate(total_items=n())%>%
  filter(pynam%in%myspecies_sci)%>%
  mutate(pynam=factor(pynam,levels=myspecies_sci),
         pdscinam=factor(pdscinam,levels=myspecies_sci))%>%
  count(pynam,pdscinam,total_items,.drop=F,name="n_prey")%>%
  mutate(prop_prey=n_prey/total_items,
         preyLab=str_to_sentence(pynam),
         preyLab=factor(preyLab,levels=str_to_sentence(myspecies_sci)),
         pdscinam=gsub(" ","\n",str_to_sentence(pdscinam)))%>%
  group_by(pdscinam)%>%
  mutate(total_prop=sum(prop_prey,na.rm=T))%>%
  group_by(pynam)%>%
  mutate(total_eaten=sum(n_prey),
         prop_eaten=total_eaten/nrow(prey19),
         nchars=nchar(as.character(preyLab)))
speciesPrey[is.na(speciesPrey)]<-0


#Levin's Niche Breadth, in different seasons

#Niche breadth function
B<-function(p) {
  a<-apply(p,2,sum)/sum(p)
  b<-(1/(sum(a^2))-1)/(length(a)-1)
  return(b)
}
#Bootstrapping function
myboot <- function(data, num) {
  resamples <- lapply(1:num, function(i) data[sample(1:nrow(data), replace=T),])
  levin <- sapply(resamples, B)
  std.dev <- sd(levin)
  list(std.dev=std.dev, levins=mean(levin))   
}


### Matrix of the diets for each individual (species as columns and individuals each row)
idCols<-c("svspp","pdcomnam","pdscinam","pdsex","pdid","pdlen","day","month","year","season","geoarea","pdgutw","declon","declat")
preyMat<-pivot_wider(prey19,id_cols=all_of(idCols),
                     names_from=gl_prey,values_from=pyamtw,values_fn=sum)%>%
  dplyr::select(-Empty)%>%
  mutate(season=factor(str_to_sentence(season),levels=c("Winter","Spring","Summer","Fall")))%>%
  filter(season%in%c("Spring","Fall"))
preyMat[is.na(preyMat)]<-0
#Number of prey categories
ncol(preyMat)-length(idCols)


levinOverTimeS<-preyMat%>%
  mutate(pdcomnam=gsub(" ","\n",str_to_title(pdcomnam)))%>%
  group_by(pdcomnam,season)%>%
  summarise(levinB=as.numeric(myboot(as.matrix(across(colnames(preyMat[,(length(idCols)+1):ncol(preyMat)]))),100)))%>%
  mutate(measure=c("levinSD","levinMean"))%>%
  pivot_wider(id_cols=c(pdcomnam,season),names_from=measure,values_from=levinB) #Separate them into two columns


#Prey lengths
pylen19<-pylen19%>%
  left_join(uniquePrey19)%>%
  mutate(declon=-declon)%>%
  mutate(Species=str_to_title(gsub(" ","\n",pdcomnam)),
         species=str_to_title(pdcomnam))

 
#What is the ratio of prey to predator lengths for the different species
pylen19<-mutate(pylen19,pypdRatio=(pylen/10)/pdlen)
#How does the skewness vary by the different species
skews<-pylen19%>%
  filter(!is.na(pypdRatio))%>%
  group_by(Species)%>%
  summarise(skew=round(skewness(pypdRatio),digits=4),
            m=max(pypdRatio))


#Dietary overlap
#Creating a proportion matrix for the prey items for my predators
propLong<-prey19%>%
  mutate(species=str_to_title(pdcomnam))%>%
  group_by(species)%>%
  mutate(total_w=sum(pyamtw),
         total_v=sum(pyamtv))%>%
  group_by(species,gl_prey)%>% 
  summarise(prop_w=sum(pyamtw)/total_w,
            prop_v=sum(pyamtv)/total_v)%>%unique()%>%ungroup()

#Following through to get the "real" overlap matrix
props1<-propLong[,-max(ncol(propLong))] #Cut off the volume prop for cleanliness
colnames(props1)<-c("species1","gl_prey","prop_w1")
props2<-propLong[,-max(ncol(propLong))]
colnames(props2)<-c("species2","gl_prey","prop_w2")

overlap_schoener<-full_join(props1,props2)%>%
  mutate(diff=abs(prop_w1-prop_w2))%>%
  group_by(species1,species2)%>%
  summarise(ep=sum(diff),
            s_do=1-0.5*ep)

overlap_mat<-pivot_wider(overlap_schoener,id_cols=c(species1),names_from=c(species2),values_from = s_do)
overlap_mat<-as.matrix(overlap_mat[,2:ncol(overlap_mat)])
for (i in 1:nrow(overlap_mat)) {
  for (j in 1:ncol(overlap_mat)) {
    overlap_mat[i,j]<-ifelse(j>i,NA,overlap_mat[i,j])
  }
}

#Clustering these out
overlap_clust<-hclust(as.dist(1-overlap_mat),method="average")
#Trying dendextend to pretty up the dendrogram
dend<-as.dendrogram(overlap_clust)


```

\newpage

## Introduction
|   The Northwest Atlantic is a highly productive ecosystem with diverse environments. It holds very high economic value as well with commercial fisheries cumulatively worth \$1.3 billion [@noaa_fisheries_2021_2021; @noaa_fisheries_2021_2021-1]. However, while the region is a focal point for marine commerce, it is also a central location in the progressive climate change occurring around the world. The Gulf of Maine, the northern end of the Northwest Atlantic, is warming faster than 99.9% of the world's oceans [@pershing_evaluating_2015]. The water body is fed primarily by cool Arctic waters, a region showing strong signals of climate change, that circulate in the deep basins, allowing them warm further. The Gulf of Maine is also linked to the south to the regions of the Georges Bank and Long Island Sound of Southern New England and the Mid-Atlantic Bight further south. These waters have historically been connected transiently, but have shown increasing homogenization in recent years.

|   As the Gulf of Maine circulating waters allow it to warm more quickly than its southern neighbors, the thermal conditions of this northern region have become more similar to past and present conditions of those areas. As such, recent decades have shown a rapid onset of species encroaching into the Gulf of Maine that had, historically, been seasonal visitors at most. New arrivals or expanding populations include those of the Atlantic blue crab (_Callinectes sapidus_), black sea bass (_Centropristis striata_), butterfish (_Peprilus triacanthus_), tautog (_Tautoga onitis_), and longfin squid (_Doryteuthis pealeii_) among many more. Similarly, species that have been historically abundant and important contributors to the Gulf of Maine ecosystem have shown appreciable declines due, at least in part, to climate change. These struggling species of the region include Atlantic cod (_Gadus morhua_), Northern shrimp (_Pandalus borealis_), Atlantic salmon (_Salmo salar_), with the collapse of American lobster (_Americanus homarus_) on the horizon in the eyes of many researchers. The reason for these changes in species' abundance within the region is due to the widespread pattern of range shifts experienced by marine organisms.

|   Species, both in marine and terrestrial ecosystems, rely on habitable conditions that are specific to their needs. Due to progressive climate change, the conditions of a local area may become inhabitable for a species or individual that previously were. This change can result in contractions of a population's range. However, as condition changes are global, it is probable that an area previously inhabitable becomes habitable for that same species allow an expansion of their range. These two components, a push and pull on a population's range, can happen simultaneously resulting in an other shift in the areas used by a species. Work has shown that the expansion or leading edge of range shifts responds more quickly to climate change than does contraction or the lagging edge [@fredston-hermann_cold_2020]. While the general case, this directional shift in population ranges is species-specific [@fredston-hermann_cold_2020] with species moving at different rates and even different directions [@chen_rapid_2011; @pinsky_climate-driven_2020]. Even further, many species instead seek cooler water temperatures by deepening their distribution [@dulvy_climate_2008]. This plurality of responses exists both around the globe as well as within a shared community [@pinsky_climate-driven_2020]; disconnecting previously interconnected communities that had been based on overlapping distributions of species. It is theorized that climate influences marine habitat suitability more strongly at the cold, leading edge whereas biotic interactions dominate at warmer, trailing edges [@fredston-hermann_cold_2020]. These two components of species range may, additionally, interact to produce a 'double whammy' for marine populations.

|   Fish, like many marine organisms, are poikilothermic meaning their body temperatures are able to range widely, pre-dominantly due to changes in their environmental temperature. Due to this substantial influence of climate conditions on the internal conditions of the individual, the physiology of fishes can range widely. Though non-linear and species-specific, a universally positive interaction of temperature and metabolic demand exists for fish. Therefore, with the rising temperatures fish experience, they are expected to increase their metabolism. Such increases require additional forage to maintain consistent individual growth and broader population biomass, though adaptations exist to reduce this pressure [@auer_flexibility_2015]. However, forage may also be struggling to maintain biomass with increased metabolisms, declining in energy density, or shifting to new locations that are less accessible for a predator. Therefore, as a global phenomenon climate change can influence predators both directly--by physiological demands of the species--and indirectly--by similarly impacting lower trophic levels. As such, predators are expected and shown to feel greater threats due to climate change than species lower in trophic level and/or with shorter generation times [@thackeray_trophic_2010].

|   As marine communities are subject to a variety of changes with complex interactions, there is potential for changes in diets of the fish predators within these communities. My objective is to conduct retrospective analyses on the diets of important predators that represent a variety of taxa and showcasing a range spatial responses. Using historical diet contents from these predators across a broad spatial area allows spatio-temporal analyses to characterize the magnitude and direction of foraging changes. Defining the patterns in dietary shifts can provide additional metrics--beyond reproductive, mobility, and habitat traits previously employed [@hare_vulnerability_2016]--to characterize the vulnerability of niches or taxa to climate change. Ultimately, informing fishers and managers about the community-wide dietary changes impact the vulnerability of those large predatory fishes that are commonly harvested can aid in their conservation and help to stabilize the community in the future.


## Methods
|   Diet contents for species were collected by the National Marine Fisheries Service Annual Spring-Fall Bottom Trawl Survey. The survey has been conducted throughout the Western Atlantic each spring (March-June) and fall (September-November) since 1968, with targeted species being subset to collect and analyze diets starting in 1973. The geographic extent of the survey is from Cape Hatteras, NC to the Bay of Fundy, Nova Scotia offshore to the continental shelf (Figure \ref{fig:map}). The survey follows a stratified random sample, with trawl locations being binned by the statistical areas (Figure \ref{fig:map}).

|   The number of diets is highly variable across species over time (Figure \ref{fig:dietNum}). Variation is a reflection of a variety of interacting elements: abundance and accessibility together represent the actual capture rate of the species, trawling effort and diet collection quotas together represent procedural elements. Quotas were defined as the number of individual diets that should be collected from each trawl binned to different fish length intervals, e.g., 1 diet per 10 cm. Diets collected were then either analyzed at sea in all cases before 1991 or frozen for analysis in the lab in `r round(nrow(filter(uniquePrey19,fhdat=="P"))/nrow(uniquePrey19)*100)` cases after 1991. 

|   Diet contents for an individual were first analyzed together with the total weight and volume being recorded. Empty diets were recorded accordingly. The individual components of occupied diets were identified to the greatest resolution possible by visual inspection. A total of `r nrow(itemDetails)-1` unique prey items were identified. To simplify analyses, distinct prey were grouped at varying levels of specificity: __General__ represents the coarsest resolution often at the phylum or class of identifiable items, __Analytical__ represents mid-level resolution grouping generally at order or family, and __Collection__ represents the lowest resolution and is often the genus or species. Fish were categorized with more specificity than invertebrates. A fourth method of grouping is included that is a functional blend of other categories utilized by @garrison_dietary_2000 in defining feeding guilds for the entire community. Namely, common prey fish species  The number of distinct prey categories named in each level of grouping is shown in Figure \ref{fig:preynames}.
#### _Data Summaries_
|
|   To initiate the exploration of dietary structure changes in time and space, it is first important to characterize species diets through a variety of metrics. These metrics may rely on a significant number of diets to be calculated accurately, but can otherwise be calculated for subsets across regions, seasons, and years for each of the species. The simplest method of assessing diet is to compare the size of the diet, either by the volume or mass. When using the mass, it is common that such a value is made relative to the mass of the fish to better compare the magnitude of feeding. Related to feeding magnitude, the mere presence of stomach contents can help to approximate the frequency of feeding. As such, the proportion of stomachs found empty can be used in characterizing foraging strategies and success. The second metric commonly used to characterize a fish diet is to calculate an index of diversity, such as Levin's Diet Breadth. The formula for Levin's breadth is:
$$B_a=\frac {\frac {1} {\sum p_j^2} -1} {n-1}$$
where $p_j$ is the proportion of the diet represented by diet item $j$, and $n$ is the total number of diet items to standardize the breadth measures between 0-1. A third metric for diets reflects the sizes of prey items, both by relating prey size to predator size and evaluating the distributions of relative prey size. Beyond a simple linear regression of the mean prey length against predator length, a regression for the 5th and 95th prey length percentiles can reveal the scope of prey size at different predator sizes. Relative prey size indicates what type of prey a species may select beyond prey identification, such as only feeding on items much smaller than oneself, taking primarily large prey near ones own size, or showing no preference for prey size. These patterns can be summarized by calculating skewness of the relative prey size distributions where higher skew represents higher selectivity. Finally, predators can be compared to each other and intra-specifically by calculating dietary overlap. Again, a variety of indices exist for calculating overlap, but one popularly used due to its simplicity is Schoener's Overlap [@schoener_nonsynchronous_1970] calculated as:
$$S_a=1-0.5*\sum |p_{1,j}-p_{2,j}|$$
where $p_1$ and $p_2$ represent the proportions of the $j$ diet item in predators $1$ and $2$, respectively. A matrix of overlap comparisons across all relevant groups can be constructed, then clustering is used to partition out similar groups.
  
  
## Discussion

The predators show signs of predation upon each other, however this is largely focused on Silver Hake, even when that requires cannibalism (Figure \ref{fig:selfprey}).

\newpage

## References

<div id="refs"></div>
 
\newpage

## Figures

__Figure \ref{fig:map}__


``` {r mapping, echo=F, message=F, warning=F,fig.width=11,fig.height=11,fig.cap="Map of the starting points for all trawls from across all years and dates from the Annual Bottom Trawl Survey. Point colors correspond to broad geographic regions: the Mid-Atlantic Bight, Southern New England, Georges Bank, Gulf of Maine, and Scotian Shelf. Black outlines show the NMFS Statistical areas used to stratify sampling.\\label{fig:map}"}



ggplot()+
  geom_polygon(data=world,aes(long,lat,group=group),fill="antiquewhite")+
  geom_polygon(data=states,aes(long,lat,group=group),fill="transparent",color="grey50")+
  geom_spatial_point(data=prey19,aes(-1*declon,declat,color=geoarea),crs=4326)+
  geom_sf(data=statAreas,fill="transparent",col="black")+
  scale_color_manual(values=colorspace::rainbow_hcl(5,c=100,end=290),name="Geographic\nRegion")+
  guides(color=guide_legend(override.aes = list(size=9)))+
  annotation_scale(location="br",width_hint=0.4,height=unit(0.125,"in"),
                   pad_x=unit(0.25,"in"),pad_y=unit(0.4,"in"),text_cex=1.2)+
  geom_rect(aes(xmin=-63.35,xmax=-62.5,ymin=35.8,ymax=36.2),fill="azure1")+
  annotation_north_arrow(location="br",pad_x=unit(0.5,"in"),pad_y=unit(0.75,"in"),
                         style = north_arrow_fancy_orienteering(text_size=15,line_width=1.25),
                         height=unit(1,"in"),width=unit(0.9,"in"))+
  coord_sf(xlim=c(-77.8,st_bbox(statAreas)$xmax),
           ylim=c(35.2,st_bbox(statAreas)$ymax))+
  theme(legend.position=c(0.225,0.8),legend.background=element_rect(color="black"),
        panel.grid.major = element_line(color=rgb(0.5,0.5,0.5,alpha=0.7),linetype="dashed",size=0.5),
        panel.background = element_rect(fill="azure1"))+
  xlab("Longitude")+ylab("Latitude")


```

\newpage

__Figure \ref{fig:dietNum}__


``` {r data summary, echo=F, message=F,warning=F,fig.width=20,fig.height=15,fig.cap="Number of diets collected for each of 9 target predator species by the National Marine Fisheries Service during the annual Spring-Fall Bottom Trawl Survey since 1973. Differences represent predator availability as well as research prioritization, both of which have varied over time. The minimum number of diets collected by a season of trawls is noted in each panel, along with the season in which it occurred. If the minimum number of diets for a species occurred in multiple seasons, the number of seasons is listed instead.\\label{fig:dietNum}"}

uniquePrey19%>%
  filter(!is.na(year)&season%in%c("SPRING","FALL"))%>%
  mutate(pdcomnam=str_to_title(pdcomnam),
         year=as.factor(year),
         season=factor(str_to_sentence(season),levels=c("Spring","Fall")))%>%
  group_by(pdcomnam,year,season,.drop=F)%>%
  summarise(count=n())%>%distinct()%>%
  filter(count>0)%>%ungroup()%>%
  mutate(yearseason=ifelse(season=="Spring",as.numeric(as.character(year))-0.25,as.numeric(as.character(year))+0.25),
         g = c(0, cumsum(diff(yearseason) > 0.5))) %>%
 ggplot()+
  geom_line(aes(yearseason,count,color=pdcomnam,group=g),size=1.5)+
  geom_point(aes(yearseason,count,fill=season,color=pdcomnam,group=g),size=3,shape=21,stroke=2)+
  geom_text(data=min,aes(2010,2010,label=paste0("Min=",min,": ",minyearseason)),size=7)+
  scale_color_manual(values=colorspace::rainbow_hcl(9,c=100,l=60),guide="none")+
  scale_fill_manual(values=seasonPal2[c(2,4)],name="Season")+
  scale_y_continuous(expand=expansion(mult=c(0.035,0.1)),name="Number of Diets Collected")+
  scale_x_continuous(name="Year")+
  guides(fill=guide_legend(override.aes=list(stroke=0.5,size=6)))+
  facet_wrap(~pdcomnam)


```

\newpage

__Figure \ref{fig:preynames}__


``` {r prey summary, echo=F, message=F, warning=F,fig.height=6,fig.width=10,fig.cap="Number of unique prey names at each level of resolution. General, Analytical, and Collection scales refer to groupings provided by the National Marine Fisheries Service; Prey name is the most specific a visual observer could identify an item to; and cf. Garrison and Link, 2000 refers to that grouping used in their feeding guild analyses.\\label{fig:preynames}"}


#How many are in each of the prey levels
itemDetails%>%
  ungroup()%>%
  pivot_longer(cols=starts_with("total"))%>%
  dplyr::select(name,value)%>%distinct()%>%
  mutate(name=factor(name))%>%
  ggplot()+
  geom_col(aes(fct_reorder(name,value),value,fill=fct_reorder(name,value)),color="black")+
  scale_fill_brewer(palette="PuRd",guide="none")+
  scale_y_continuous(name="Number of unique items")+
  scale_x_discrete(name="Prey Resolution",
                     labels=c("General","cf. Garrison\nand Link, 2000","Analytical","Collection","Species"))
  
  
```

\newpage

__Figure \ref{fig:relConsump}__


``` {r consump, echo=F, message=F, warning=F,fig.height=6,fig.width=10,fig.cap="Relative consumption as the mass of the diet over the mass of the fish for each of the focal predators. Note the log-scale for the y-axis.\\label{fig:relConsump}"}

 
uniquePrey19%>%
  mutate(pdcomnam=str_to_title(gsub(" ","\n",pdcomnam)),
         relConsump=pdgutw/pdwgt)%>%
  filter(relConsump>0 & relConsump<1)%>% #Only keep those that have a fish and diet weight
  ggplot()+
  geom_jitter(aes(fct_reorder(pdcomnam,relConsump),relConsump,color=pdcomnam),
              shape=21,alpha=0.75,width=0.125)+
  geom_boxplot(aes(fct_reorder(pdcomnam,relConsump),relConsump,fill=pdcomnam),outlier.shape=NA,
               size=1.5,color="black",alpha=0.5)+
  theme(legend.position = "none")+
  scale_fill_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  scale_color_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  scale_x_discrete(name="Predator Species")+
  scale_y_log10(name="Relative Consumption (g/g)",
                breaks=c(0.00001,0.0001,0.001,0.01,0.1,1),labels=function(x) format(x,scientific=F))



```


\newpage

__Figure \ref{fig:empty}__


``` {r emptiness, echo=F,message=F,warning=F,fig.width=24,fig.height=24,fig.cap="Percentage of stomachs that are empty over time for each of the predator species in each of the geographic regions. The rightmost columns represents the cumulative across regions for each species. The bottom row represents the cumulative across species for each region. Horizontal red lines in each show the mean across all years for that subset. Regions are ordered by increasing latitude from left to right, species are ordered by increasing percentage of empty stomachs from top to bottom.\\label{fig:empty}"}

#Over the years for each species
s<-prey19%>%
  mutate(ID=paste(svspp,cruise6,station,pdsex,pdid,pdlen,pdwgt,sep="-"))%>%
  group_by(pdcomnam)%>%
  mutate(total=n_distinct(ID))%>%
  group_by(gensci,pdcomnam,total)%>%
  mutate(total_empty=n_distinct(ID),
         total_p_empty=(total_empty/total)*100)%>%ungroup()%>%
  group_by(pdcomnam,year)%>%
  mutate(IDs=n_distinct(ID))%>%
  group_by(gensci,pdcomnam,year,IDs,total,total_empty,total_p_empty)%>%
  summarise(N_empty=n_distinct(ID),
            p_empty=(N_empty/IDs)*100)%>%filter(gensci=="EMPTY")%>%unique()%>%ungroup()%>%
  mutate(f.pdcomnam=fct_reorder(as.factor(str_to_title(pdcomnam)),p_empty))%>%
  ggplot(aes(year,p_empty,color=pdcomnam,fill=pdcomnam))+
  geom_abline(aes(slope=0,intercept=total_p_empty),color="firebrick2",size=1.5)+
  geom_line(size=2)+
  geom_point(size=3,shape=21,stroke=1.5,color="black")+
  scale_x_continuous(name="Year")+
  scale_y_continuous(name="Percent Empty Stomachs (%)",limits=c(0,100))+
  #scale_size_continuous(name="Number of\nDiets",range=c(1.5,7))+
  scale_fill_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  scale_color_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  theme(legend.position = "none")+
  facet_wrap(~f.pdcomnam,nrow=9)
 

#Over the years for each area
g<-prey19%>%
  mutate(ID=paste(svspp,cruise6,station,pdsex,pdid,pdlen,pdwgt,sep="-"))%>%
  group_by(geoarea)%>%
  mutate(total=n_distinct(ID))%>%
  group_by(gensci,geoarea,total)%>%
  mutate(total_empty=n_distinct(ID),
         total_p_empty=(total_empty/total)*100)%>%ungroup()%>%
  group_by(geoarea,year)%>%
  mutate(IDs=n_distinct(ID))%>%
  group_by(gensci,geoarea,year,IDs,total,total_empty,total_p_empty)%>%
  summarise(N_empty=n_distinct(ID),
            p_empty=(N_empty/IDs)*100)%>%filter(gensci=="EMPTY")%>%unique()%>%ungroup()%>%
  mutate(geoarea=factor(geoarea,levels=c("MAB","SNE","GB","GoM","ScS")))%>%
  ggplot(aes(year,p_empty,shape=geoarea))+
  geom_abline(aes(slope=0,intercept=total_p_empty),color="firebrick2",size=1.5)+
  geom_line(color="black",size=2)+
  geom_point(fill="black",size=3,stroke=1.5)+
  scale_x_continuous(name="Year")+
  scale_y_continuous(name="Percent Empty Stomachs (%)",limits=c(0,100))+
  #scale_size_continuous(name="Number of\nDiets",range=c(1.5,7))+
  scale_shape_manual(values=c(21:25),guide="none")+
  facet_wrap(~geoarea,nrow=1)


#Over the years for each species in each area
a<-prey19%>%
  mutate(ID=paste(svspp,cruise6,station,pdsex,pdid,pdlen,pdwgt,sep="-"))%>%
  group_by(pdcomnam,geoarea)%>%
  mutate(total=n_distinct(ID))%>%
  group_by(gensci,pdcomnam,geoarea,total)%>%
  mutate(total_empty=n_distinct(ID),
         total_p_empty=(total_empty/total)*100)%>%ungroup()%>%
  group_by(pdcomnam,geoarea,year)%>%
  mutate(IDs=n_distinct(ID))%>%
  group_by(gensci,pdcomnam,geoarea,year,IDs,total,total_empty,total_p_empty)%>%
  summarise(N_empty=n_distinct(ID),
            p_empty=(N_empty/IDs)*100)%>%filter(gensci=="EMPTY")%>%unique()%>%ungroup()%>%
  mutate(f.pdcomnam=fct_reorder(as.factor(str_to_title(pdcomnam)),p_empty),
         geoarea=factor(geoarea,levels=c("MAB","SNE","GB","GoM","ScS")))%>%
  ggplot(aes(year,p_empty,color=pdcomnam,fill=pdcomnam,shape=geoarea))+
  geom_abline(aes(slope=0,intercept=total_p_empty),color="firebrick2",size=1.5)+
  geom_line(size=2,show.legend = F)+
  geom_point(size=3,stroke=1.25,color="black")+
  scale_x_continuous(name="Year")+
  scale_y_continuous(name="Percent Empty Stomachs (%)",limits=c(0,100))+
  #scale_size_continuous(name="Number of\nDiets",range=c(1.5,7))+
  scale_fill_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  scale_color_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  scale_shape_manual(values=c(21:25))+
  guides(fill="none",shape="none")+
  theme(plot.margin=unit(c(12.5,15,15,12.5),"pt"))+
  facet_wrap(~f.pdcomnam+geoarea,nrow=9,labeller = label_wrap_gen(multi_line=FALSE))


#Put them all together
grid.arrange(a,s,g,nrow=2,layout_matrix=rbind(c(1,1,1,2),
                                              c(1,1,1,2),
                                              c(1,1,1,2),
                                              c(1,1,1,2),
                                              c(3,3,3,NA)))






```

\newpage

__Figure \ref{fig:levin}__


``` {r breadth, echo=F,message=F,warning=F,fig.width=10,fig.height=6,fig.cap="Mean Levin's Niche Breadth for each focal predator in the two major seasons collected. Errorbars represent standard deviation as calculated from 100 bootstrap resamples.\\label{fig:levin}"}

#Plotting
levinOverTimeS%>%
  ggplot(aes(fct_reorder(pdcomnam,levinMean),levinMean,fill=season))+
  geom_col(color="black",position=position_dodge(0.9))+
  geom_errorbar(aes(ymin=levinMean-levinSD,ymax=levinMean+levinSD),position=position_dodge(0.9),width=0.25)+
  theme(legend.position=c(0.15,0.8),legend.background = element_rect(color="black"))+
  scale_fill_manual(values=seasonPal2[c(2,4)],name="Season")+
  scale_y_continuous(name="Levin's Niche Breadth")+
  scale_x_discrete(name="Predator Species")
  

```

\newpage

__Figure \ref{fig:pylen}__


``` {r sizes, echo=F,message=F,warning=F,fig.width=20,fig.height=10,fig.cap="Relationship of the sizes of predators to the sizes of their prey showing the (left) range of prey sizes against all predator sizes and (right) distribution of relative prey sizes. The solid line in each panel represents the mean prey size, dashed lines represent the 5th and 95th percentile prey sizes. Skewness scores are listed above each species violin plot with increasing skewness, on the right, showing higher selectivity for prey size.\\label{fig:pylen}"}


#How do the predators compare to their prey
r<-pylen19%>%
  filter(!is.na(pdcomnam))%>%
  ggplot()+
  geom_abline(aes(slope=1,intercept=0))+
  geom_point(aes(pdlen,pylen/10,color=Species),shape=21,size=2,fill="transparent")+
  geom_smooth(aes(pdlen,pylen/10),method="lm",lty=1,se=F,color="black")+ #Mean line
  geom_smooth(data=pylen19%>%filter(!is.na(pdcomnam))%>%mutate(lengths=as.character(pdlen))%>%
                    group_by(species,lengths)%>%mutate(N=n())%>%filter(pylen>=quantile(pylen,probs=0.95,na.rm=T)),
             aes(pdlen,pylen/10),method="lm",lty=3,se=F,color="black")+ #Max prey size line
  geom_smooth(data=pylen19%>%filter(!is.na(pdcomnam))%>%mutate(lengths=as.character(pdlen))%>%
                group_by(species,lengths)%>%mutate(N=n())%>%filter(pylen<=quantile(pylen,probs=0.05,na.rm=T)),
              aes(pdlen,pylen/10),method="lm",lty=3,se=F,color="black")+ #Min prey size line
  scale_color_manual(values=colorspace::rainbow_hcl(9,c=100,l=60),guide="none")+
  scale_x_continuous(limits=c(0,130),expand=expansion(mult=0.01),name="Predator length (cm)")+
  scale_y_continuous(limits=c(0,130),expand=expansion(mult=0.01),name="Prey length (cm)")+
  theme(legend.position=c(0.33,0.75),legend.background=element_rect(color="black",fill="white"))+
  facet_wrap(~species)

v<-pylen19%>%
  filter(!is.na(pdcomnam))%>%
  left_join(skews)%>%
  ggplot()+
  geom_point(aes(fct_reorder(Species,skew),pypdRatio,fill=Species),shape=21,alpha=0.8,size=2,show.legend=F)+
  geom_violin(aes(fct_reorder(Species,skew),pypdRatio,fill=Species),size=1.5,show.legend=F)+
  geom_text(data=skews,aes(Species,m+0.05,label=skew),size=6)+
  scale_fill_manual(values=colorspace::rainbow_hcl(9,c=100,l=60))+
  scale_y_continuous(name="Ratio of Prey Length:Predator Length",expand=expansion(add=c(0.0325,0.112)))+
  scale_x_discrete(name="Predator Species")

grid.arrange(r,v,nrow=1)


```

\newpage

__Figure \ref{fig:schoener}__

``` {r overlap, echo=F,message=F,warning=F,fig.height=6,fig.cap="Focal predators clustered by similarity in diet composition according. Hierarchical agglomerative clustering using the group average was performed from a matrix of Schoener's dietary overlap to generate this dendrogram.\\label{fig:schoener}"}


dend %>% 
  set("branches_lwd", 2) %>%
  # Custom labels
  set("labels_cex",1)%>%
  set("labels",gsub(" ","\n",labels(dend)))%>%
  as.ggdend()%>%
  ggplot(horiz=T,offset_labels=-0.01)+
  theme_void()

#grid.arrange(m,d,nrow=3,layout_matrix=rbind(c(1,1,1,1),
#                                            c(1,1,1,1),
#                                            c(2,2,2,NA)))


```

\newpage

__Figure \ref{fig:selfprey}__


``` {r cannibal, echo=F,message=F,warning=F,fig.width=12,fig.height=8,fig.cap="Proportion of consumption for each predator species of the other predator species, including cannibalism. Red lines represent the total proportion on self and other target predator species. Prey names include the number of instances of predation upon that species. Note square-root scale for proportions.\\label{fig:selfprey}"}

ggplot(speciesPrey,aes(fct_reorder(pdscinam,total_prop),prop_prey,fill=preyLab))+
  geom_col(position = "dodge",color="black",size=0.5)+
  geom_errorbar(aes(ymin=total_prop,ymax=total_prop), color = "firebrick3") +
  #geom_segment(aes(x=pdscinam-1,xend=pdscinam,y=total_prop,yend=total_prop),size=5,shape=22,fill="firebrick2")+
  scale_x_discrete(name="Predator Species")+
  scale_y_sqrt(name="Proportion of Predator Diet",expand=expansion(add=c(0.001,0.01)))+
  scale_fill_viridis_d(name="Prey Species", 
                       labels=paste0(speciesPrey$preyLab,strrep(" ",25-speciesPrey$nchars),"(n=",speciesPrey$total_eaten,")"))+
  theme(legend.position=c(0.7,0.25),legend.background=element_rect(color="black"),
        legend.text=element_text(family="mono",size=15))+
  coord_flip()


```

